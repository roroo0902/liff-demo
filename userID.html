<script>
    document.addEventListener("DOMContentLoaded", function () {
        liff.init({ liffId: "2007051903-2ajakdbl" })
            .then(() => {
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    redirectToGoogleForm();
                }
            })
            .catch(err => console.error("LIFF 初始化失敗:", err));
    });

    function redirectToGoogleForm() {
        liff.getProfile()
            .then(profile => {
                console.log("使用者名稱:", profile.displayName);
                console.log("使用者 ID:", profile.userId);

                const userName = encodeURIComponent(profile.displayName);
                const userId = encodeURIComponent(profile.userId);

                // ✅ Google 表單 URL（讓使用者填寫，但 `userName` & `userId` 由 `GAS` 處理）
                const googleFormBaseUrl = "https://docs.google.com/forms/d/e/1FAIpQLSevkZz6ffohW_iUzzGp0Bzmq5TE2gHb3TEBVzQzI5JUcDhm8A/viewform?usp=pp_url";

                // ✅ 直接打開 Google 表單
                window.location.href = googleFormBaseUrl;

                // ✅ `fetch()` 將 `userName` & `userId` 傳給 `GAS`
                const googleScriptURL = "https://script.google.com/macros/s/AKfycbyzr-AgAC6dBUxeAiFyEiPn5yJxv19FpNJQ6PTOVyQ1yrxDDeMDXBXEVvdaWZA4Hr_QVg/exec";

                fetch(`${googleScriptURL}?userName=${userName}&userId=${userId}`, { mode: 'no-cors' })
                    .then(() => console.log("Google 試算表已更新！"))
                    .catch(err => console.error("提交失敗:", err));
            })
            .catch(err => {
                console.error("獲取用戶資訊失敗:", err);
                alert("無法獲取使用者資訊，請確保 LIFF 權限已正確設定。");
            });
    }
</script>
